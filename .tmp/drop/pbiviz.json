{"visual":{"name":"PowerBI-visuals-spline","displayName":"Spline","guid":"PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167","visualClassName":"Visual","version":"1.0.0","description":"<span>Smoothing spline helps you visualize and understand noisy data. Control the colors and the rest of attributes to meet your specific needs.<br/><br/><span style='font-style:italic'>Service prerequisites:</span> R-powered custom visual is used in service seamlessly<br/><br /><span style='font-style:italic'>Desktop prerequisites:</span> To run R scripts in Power BI Desktop, you must separately install R on your local computer.<br />You can download and install R for free from the <a href='https://mran.revolutionanalytics.com/download/'>Revolution Open download page</a> or the <a href='https://cran.r-project.org/bin/windows/base/'>CRAN Repository</a><br /><br /> <span style='font-style:italic'> R package dependencies(auto-installed): </span> graphics, scales, reshape <br /></span>","supportUrl":"http://community.powerbi.com/","gitHubUrl":"https://github.com/microsoft/PowerBI-visuals-spline"},"apiVersion":"1.2.0","author":{"name":"Microsoft","email":"pbicvsupport@microsoft.com"},"assets":{"icon":"assets/icon.png"},"externalJS":[],"style":"style/visual.less","capabilities":{"dataRoles":[{"displayName":"X axis","kind":"Grouping","name":"x_var"},{"displayName":"Y Axis","kind":"GroupingOrMeasure","name":"y_var"},{"displayName":"Point Color","kind":"Grouping","name":"color"}],"dataViewMappings":[{"conditions":[{"x_var":{"max":1},"y_var":{"max":1},"color":{"max":1}}],"scriptResult":{"dataInput":{"table":{"rows":{"select":[{"for":{"in":"x_var"}},{"for":{"in":"y_var"}},{"for":{"in":"color"}}],"dataReductionAlgorithm":{"top":{}}}}},"script":{"scriptProviderDefault":"R","scriptOutputType":"png","source":{"objectName":"rcv_script","propertyName":"source"},"provider":{"objectName":"rcv_script","propertyName":"provider"},"scriptSourceDefault":"# Copyright (c) Microsoft Corporation.  All rights reserved.\r\n\r\n# Third Party Programs. This software enables you to obtain software applications from other sources. \r\n# Those applications are offered and distributed by third parties under their own license terms.\r\n# Microsoft is not developing, distributing or licensing those applications to you, but instead, \r\n# as a convenience, enables you to use this software to obtain those applications directly from \r\n# the application providers.\r\n# By using the software, you acknowledge and agree that you are obtaining the applications directly\r\n# from the third party providers and under separate license terms, and that it is your responsibility to locate, \r\n# understand and comply with those license terms.\r\n# Microsoft grants you no license rights for third-party software or applications that is obtained using this software.\r\n\r\n\r\n##PBI_R_VISUAL: VIZGAL_SPLINE   Visualization of spline interpolation\r\n# Computes and visualizes a spline interpolation of 2D scatter \r\n# Smoothness is controlled by the user \r\n# INPUT: \r\n# The input dataset should include exactly two numerical non-constant columns for X and Y  \r\n#\r\n# EXAMPLES:\r\n## for R environment\r\n# library(zoo)\r\n# library(reshape)\r\n# dat=BJsales.lead  \r\n# BJsaleData=data.frame(ind=index(dat),date=as.Date(dat),value=melt(dat)$value)\r\n# dataset=data.frame(x=BJsaleData$ind,y=BJsaleData$value)\r\n# source(\"visGal_spline.R\") #create graphics\r\n#\r\n# WARNINGS:  \r\n#\r\n# CREATION DATE: 24/7/2016\r\n#\r\n# LAST UPDATE: 26/7/2017\r\n#\r\n# VERSION: 0.0.2\r\n#\r\n# R VERSION TESTED: 3.2.2\r\n# \r\n# AUTHOR: Jacob Minsky (t-jacobm@microsoft.com)\r\n#\r\n# REFERENCES: https://stat.ethz.ch/R-manual/R-devel/library/stats/html/loess.html\r\n#save(list=ls(all.names=TRUE), file=\"c:/users/t-jacobm/Documents/cvis.rdata\")\r\n\r\n\r\n#PBI_EXAMPLE_DATASET for debugging purposes \r\n\r\n\r\n############ User Parameters #########\r\n##PBI_PARAM: Should warnings text be displayed?\r\n#Type:logical, Default:TRUE, Range:NA, PossibleValues:NA, Remarks: NA\r\nshowWarnings=TRUE\r\n\r\n##PBI_PARAM Smoothness of spline. Small values correspond for wiggly spline, large values for smooth spline \r\n#Type: integer, Default:30, Range:[1,100], PossibleValues:NA, Remarks: Used to control \"span\" parameter \r\nsmoothness = 30\r\nif(exists(\"settings_spline_params_percentile\")){\r\n  smoothness = settings_spline_params_percentile\r\n}\r\n\r\n##PBI_PARAM Confidence level band display\r\n#Type:logical, Default:TRUE, Range:NA, PossibleValues:NA, Remarks: NA\r\ndrawConfidenceLevels = TRUE\r\nif(exists(\"settings_conf_params_showConf\")){\r\n  drawConfidenceLevels = settings_conf_params_showConf\r\n}\r\n\r\n###############Library Declarations###############\r\nlibraryRequireInstall = function(packageName, ...)\r\n{\r\n  if(!require(packageName, character.only = TRUE)) \r\n    warning(paste(\"*** The package: '\", packageName, \"' was not installed ***\",sep=\"\"))\r\n}\r\n\r\nlibraryRequireInstall(\"reshape\")\r\nlibraryRequireInstall(\"graphics\")\r\nlibraryRequireInstall(\"splines\")\r\nlibraryRequireInstall(\"scales\")\r\n\r\n###############Internal parameters definitions#################\r\n#PBI_PARAM Minimal number of points for spline\r\n#Type:integer, Default:7, Range:[3,100], PossibleValues:NA, Remarks: NA\r\nminPoints = 7\r\n\r\n##PBI_PARAM Confidence level percentage; 0.95 is 95%\r\n#Type:numeric, Default:0.99, Range:[0,1], PossibleValues:NA, Remarks: NA\r\nconfLevel = 0.99\r\nif(exists(\"settings_conf_params_confLevel\")){\r\n  confLevel = settings_conf_params_confLevel\r\n}\r\n\r\n##PBI_PARAM Color of scatterplot points\r\n#Type:string, Default:\"orange\", Range:NA, PossibleValues:\"orange\",\"blue\",\"green\",\"black\"\r\npointsCol = \"orange\"\r\nif(exists(\"settings_scatter_params_pointColor\")){\r\n  pointsCol = settings_scatter_params_pointColor\r\n}\r\n\r\n##PBI_PARAM Color of spline plot\r\n#Type:string, Default:\"orange\", Range:NA, PossibleValues:\"orange\",\"blue\",\"green\",\"black\"\r\nlineColor = \"turquoise\"\r\nif(exists(\"settings_spline_params_lineColor\")){\r\n  lineColor = settings_spline_params_lineColor\r\n}\r\n\r\n#PBI_PARAM Transparency of scatterplot points\r\n#Type:numeric, Default:0.4, Range:[0,1], PossibleValues:NA, Remarks: NA\r\ntransparency = 0.5\r\n\r\n#PBI_PARAM Shaded band for confidence interval\r\n#Type:logical, Default:TRUE, Range:NA, PossibleValues:NA, Remarks: NA\r\nfillConfidenceLevels = TRUE\r\n\r\n#PBI_PARAM Span for loess regression\r\n#Type:numeric or NA, Default: NA, Range:(0.1,3], PossibleValues:NA, \r\n#Remarks: If span is NA or NULL the smoothness \r\nspan = NA\r\n\r\n#PBI_PARAM Size of points on the plot\r\n#Type:numeric, Default: 1 , Range:[0.1,5], PossibleValues:NA, Remarks: NA\r\npointCex = 1\r\n\r\n###############Internal functions definitions#################\r\n\r\n#if it attributeColumn is legal colors() use them \r\n#if all the entries in attributeColumn are the same number - use defaultColor\r\n#if it has many numeric variables color from green to red range \r\n#if it has few unique strings - use rainbow to color them \r\nColorPerPoint = function (attributeColumn, defaultColor = pointsCol, sizeColRange = 30)\r\n{\r\n  N = length(attributeColumn)\r\n  if(sum(attributeColumn %in% colors()) == N) # all legal colors\r\n    return(attributeColumn)\r\n  \r\n  UN = length(unique(attributeColumn))\r\n  if(UN == 1) # single number \r\n    return(defaultColor)\r\n  \r\n  sortedUniqueValues = sort(unique(attributeColumn))\r\n  \r\n  if(UN >= N - 2 && is.numeric(attributeColumn)) # many numbers --> color range \r\n  {\r\n    rangeColors = terrain.colors(sizeColRange)# 30 colors\r\n    breaks = seq(min(sortedUniqueValues), max(sortedUniqueValues),length.out = sizeColRange + 1)\r\n    pointsCol = as.character(cut(attributeColumn, breaks,labels = rangeColors))\r\n    return(pointsCol)\r\n  } else {\r\n    rangeColors = rainbow(UN)\r\n    names(rangeColors) = sortedUniqueValues\r\n    return(rangeColors[as.character(attributeColumn)])\r\n  }\r\n}\r\n\r\n###############Upfront input correctness validations (where possible)#################\r\npbiWarning = NULL\r\n\r\nif (exists(\"x_var\") && exists(\"y_var\")){\r\n\r\n  if(exists(\"color\")) {\r\n    dataset=cbind(x_var,y_var,color)\r\n  } else {\r\n    dataset=cbind(x_var,y_var)\r\n  }\r\n  \r\n  dataset<-dataset[complete.cases(dataset),] #remove corrupted rows\r\n  \r\n  if(is.null(span) || is.na(span))\r\n    span=smoothness/50\r\n  \r\n  if(ncol(dataset) > 2)\r\n    pointsCol = ColorPerPoint(dataset[,3],pointsCol)\r\n  \r\n  ##############Main Visualization script###########\r\n  \r\n  \r\n  cNames <- names(dataset)\r\n  \r\n  if(nrow(dataset) >= minPoints) {\r\n    \r\n    names(dataset) = c(\"x\", \"y\")\r\n    \r\n    #x=as.numeric(x[,1])\r\n    #y=as.numeric(y[,1])\r\n    \r\n    attach(dataset)\r\n    new.x = seq(min(dataset[, 1]), max(dataset[,1]), length.out = 100)\r\n    \r\n    fit <- tryCatch(\r\n      {\r\n        loess(y ~ x, family = \"gaussian\", span = span)\r\n      },\r\n      error=function(cond) {\r\n        return(list())\r\n      }\r\n    )\r\n    plot(x, y, xlim = c(min(x), max(x)), ylim=c(min(y), max(y)), pch = 19, cex = pointCex,\r\n         ylab = cNames[2], xlab = cNames[1],col = alpha(pointsCol, transparency))\r\n    \r\n    if (length(fit) != 0) {     \r\n      \r\n      prediction = predict(fit, data.frame(x = new.x), se = TRUE)\r\n      spline_plot = prediction$fit\r\n      \r\n      if (drawConfidenceLevels) {\r\n        spline_plot = cbind(\r\n          spline_plot,\r\n          prediction$fit + (prediction$se.fit)*qnorm(1 - (1 - confLevel)/2),\r\n          prediction$fit - prediction$se.fit*qnorm(1 - (1 - confLevel)/2)\r\n        )\r\n      }\r\n      \r\n      if (drawConfidenceLevels && fillConfidenceLevels) # add fill\r\n        polygon(c(rev(new.x), new.x), c(rev(spline_plot[ ,3]), spline_plot[ ,2]), col = alpha('grey80',transparency), border = NA)\r\n      \r\n      matplot(new.x, spline_plot, lwd = c(3,1,1), lty = c(1,2,2), col = c(lineColor,\"red\",\"red\"), type = \"l\", add = TRUE)\r\n    } else {\r\n      showWarnings = TRUE\r\n      pbiWarning<-paste(pbiWarning, \"Regression failed: possibly no pattern in data\", sep=\"\\n\")\r\n    }\r\n  } else { # note enough points\r\n    plot.new()\r\n    pbiWarning<-paste(pbiWarning, \"Not enough points for plot\", sep=\"\\n\")\r\n  }\r\n} else{ #No X and Y columns\r\n  plot.new()\r\n  pbiWarning<-paste(pbiWarning, \"Need numeric X and Y variables\", sep=\"\\n\")\r\n}\r\n\r\n#add warning as subtitle\r\nif(showWarnings)\r\n  title(main = NULL, sub = pbiWarning, outer = FALSE, col.sub = \"gray50\", cex.sub=0.75)\r\n\r\nremove('dataset')\r\n\r\n"}}}],"objects":{"rcv_script":{"properties":{"provider":{"type":{"text":true}},"source":{"type":{"scripting":{"source":true}}}}},"settings_spline_params":{"displayName":"Spline Settings","properties":{"percentile":{"displayName":"Smoothness","type":{"numeric":true}},"lineColor":{"displayName":"Line Color","type":{"fill":{"solid":{"color":true}}}}}},"settings_conf_params":{"displayName":"Confidence Level","properties":{"confLevel":{"displayName":"Confidence Level","type":{"numeric":true}},"showConf":{"displayName":"Show Confidence interval","type":{"bool":true}}}},"settings_scatter_params":{"displayName":"Scatter Plot","properties":{"pointColor":{"displayName":"Point Color","description":"Used only if `Point Color` field is empty","type":{"fill":{"solid":{"color":true}}}}}}},"suppressDefaultTitle":true},"dependencies":{"cranPackages":[{"name":"graphics","displayName":"The R Graphics Package","url":"stat.ethz.ch/R-manual/R-patched/library/graphics/html/00Index.html"},{"name":"scales","displayName":"scales: Scale Functions for Visualization","url":"https://cran.r-project.org/web/packages/scales/index.html"},{"name":"reshape","displayName":"reshape:  lets you flexibly restructure and aggregate data","url":"https://cran.r-project.org/web/packages/reshape/index.html"}]},"content":{"js":"var powerbi;!function(e){var t;!function(e){var t;!function(e){var t;!function(e){function t(e,t,i,s){if(e){var n=e[t];if(n){var a=n[i];if(void 0!==a)return a}}return s}function i(e,t,i,s,n){var a=e.objects;if(a){var o=a[t];if(o){var r=o[i];if(r){var l=r[s];if(void 0!==l)return l}}}return n}e.getValue=t,e.getCategoricalObjectValue=i}(t=e.PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167||(e.PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167={}))}(t=e.visual||(e.visual={}))}(t=e.extensibility||(e.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(e){var t;!function(e){var t;!function(e){var t;!function(e){var t=function(){function t(e){this.imageDiv=document.createElement(\"div\"),this.imageDiv.className=\"rcv_autoScaleImageContainer\",e.element.appendChild(this.imageDiv),this.imageElement=document.createElement(\"img\"),this.imageElement.className=\"rcv_autoScaleImage\",this.imageDiv.appendChild(this.imageElement),this.settings_spline={smoothness:30,lineColor:\"red\"},this.settings_scatter={pointColor:\"blue\"},this.settings_conf={showConf:!0,confLevel:.99}}return t.prototype.update=function(t){var i=t.dataViews;if(i&&0!==i.length){var s=i[0];if(s&&s.metadata){this.settings_spline={smoothness:e.getValue(s.metadata.objects,\"settings_spline_params\",\"percentile\",30),lineColor:e.getValue(s.metadata.objects,\"settings_spline_params\",\"lineColor\",\"red\")},this.settings_scatter={pointColor:e.getValue(s.metadata.objects,\"settings_scatter_params\",\"pointColor\",\"blue\")},this.settings_conf={confLevel:e.getValue(s.metadata.objects,\"settings_conf_params\",\"confLevel\",.99),showConf:e.getValue(s.metadata.objects,\"settings_conf_params\",\"showConf\",!0)};var n=null;s.scriptResult&&s.scriptResult.payloadBase64&&(n=\"data:image/png;base64,\"+s.scriptResult.payloadBase64),n?this.imageElement.src=n:this.imageElement.src=null,this.onResizing(t.viewport)}}},t.prototype.onResizing=function(e){this.imageDiv.style.height=e.height+\"px\",this.imageDiv.style.width=e.width+\"px\"},t.prototype.enumerateObjectInstances=function(e){var t=e.objectName,i=[];switch(t){case\"settings_spline_params\":i.push({objectName:t,properties:{percentile:this.settings_spline.smoothness,lineColor:this.settings_spline.lineColor},selector:null});break;case\"settings_conf_params\":i.push({objectName:t,properties:{confLevel:this.settings_conf.confLevel,showConf:this.settings_conf.showConf},selector:null});break;case\"settings_scatter_params\":i.push({objectName:t,properties:{pointColor:this.settings_scatter.pointColor},selector:null})}return i},t}();e.Visual=t}(t=e.PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167||(e.PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167={}))}(t=e.visual||(e.visual={}))}(t=e.extensibility||(e.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(e){var t;!function(t){var i;!function(t){t.PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167={name:\"PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167\",displayName:\"Spline\",class:\"Visual\",version:\"1.0.0\",apiVersion:\"1.2.0\",create:function(t){return new e.extensibility.visual.PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167.Visual(t)},custom:!0}}(i=t.plugins||(t.plugins={}))}(t=e.visuals||(e.visuals={}))}(powerbi||(powerbi={}));","css":".visual-PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167 .rcv_autoScaleImageContainer{position:relative}.visual-PBI_CV_3DFBB0D1_6AFB_4242_B6E1_7116023B1167 .rcv_autoScaleImageContainer .rcv_autoScaleImage{max-width:100%;max-height:100%;position:absolute;top:50%;left:50%;transform:translateY(-50%) translateX(-50%);-webkit-transform:translateY(-50%) translateX(-50%)}","iconBase64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAapJREFUeNpiYKAF6J04pYFaZjFB6Xp0iUuXLicAsQA2TUBxBUIGomsAGdSPyyIgdR9Kw8QMYGwWHBaBDAIZWgBUvFFPT/cAksZ+qJr5QD5M/XwgZsRqINQ7BUhCIMWKUFfvh1qELIcCWHC4DhkoAA0DucoBzTAGxp/fGTiPb2FgfXILexhCXQcOG7a7F8EaoADkYgNktSBD+Je0MLC8fszw2S8D04VAw0AuyAexuXcuBBsIAt8tfRh+GDphuIr92nEMOXQv7wcp5t00HazpY0w1A/OntxDD71xg+OIeD3TNEzD/t4waw4fkVob/7JwMOMOQGaiYB6j4j6gMwzeHMLDif3zCQINrGDjO72UQmFsNFONi+Ao0+JeyPkzbBSAOBOL1GAbyre5j+GHkxPDdwgfFRpDBILGfWpZgA5FcBTLMEZikPgCDyxEjUr45hGIYBtIA1Qh2LTbDQBwYjWIgyAVoYAI0QcMNxWYYvqyXCMUgAFLciGQ7zFC8hiGXNv+Rks9+5HyKnL9xFRaEDFSgRvEFB0DvPKDEQEZ0F1ICivNzGGFedqBWiQ0QYADsX74TmkRocgAAAABJRU5ErkJggg=="}}